<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<dom-module id="blogger-list">
  <template>
    <iron-ajax auto url="{{url}}" handle-as="json" last-response="{{ajaxResponse}}"></iron-ajax>
    <ul>
      <template is="dom-repeat" items="[[ajaxResponse.items]]" sort="_sort" filter="_filter">
        <li><a href="{{item.url}}">{{item.title}}</a></li>
      </template>
    </ul>
  </template>
  <script>
    Polymer({
      is: 'blogger-list',
      properties: {
        labels: String,
        blogId: String,
        apiKey: String,
        asc: Boolean,
        maxResults: {
          value: 50,
          type: Number
        }
      },
      attached: function() {
        if(!this.blogId) {
          throw new Error("\<blogger-list\> blog-id is required");
        }
        if(!this.apiKey){
          throw new Error("\<blogger-list\> api-key is required");
        }

        if(this.labels){
          this.url = this._getPostsByLabelUrl();
        }else{
          this.url = this._getPostsUrl();
        }
      },

      _bloggerUrl: function(path, params){
        var url = "https://www.googleapis.com/blogger/v3/blogs/"
          + this.blogId
          + path
          + "?maxResults=" + this.maxResults //does not work with labels query but _filter() takes care of limiting the displayed results
          + "&fields=items(title,url,published)"
          + "&key=" + this.apiKey;

        if(params){
          for(var i in params){
            url += "&" + i + "=" + params[i];
          }
        }
        return url;
      },

      _getPostsUrl: function(){
        return this._bloggerUrl("/posts");
      },

      _getPostsByLabelUrl: function(){
        //multiple label query looks like this q=label:pasta|label:pizza
        var labelsQuery = "label:" + this.labels.split(",").join("|label:");
        return this._bloggerUrl("/posts/search",{
          q: labelsQuery
        });
      },

      _sort: function(a, b){
        var aDate = new Date(a.published);
        var bDate = new Date(b.published);

        if(this.asc){
          return aDate < bDate ? -1 : 1;
        }else{
          return aDate < bDate ? 1 : -1;
        }
      },

      _filter: function(item){
        return this.ajaxResponse.items.indexOf(item) < this.maxResults;
      }
    });
  </script>
</dom-module>